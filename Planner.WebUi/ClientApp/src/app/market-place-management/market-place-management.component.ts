import { Component, OnInit } from '@angular/core';
import { FormGroup, FormBuilder, FormArray, Validators } from '@angular/forms';
import { ActivatedRoute } from '@angular/router';
import { LoadingService } from '../core/services/loading.service';
import { ToastrService } from 'ngx-toastr';
import { HotelService } from '../core/services/hotel.service';
import { BehaviorSubject } from 'rxjs';
import { GetPageOfExperienceCompensationsQuery, GetExperienceCompensationDetailsQuery, InsertExperienceCompensationCommand, PageOfOfExperienceCompensationGridItemViewModel, ProcessResponse, ProcessResponseOfGuid, ExperienceCompensationDetailsViewModel, ExperienceCompensationGridItemViewModel, ExperienceCompensationManagementClient, UpdateExperienceCompensationCommand } from '../core/autogenerated-clients/api-client';
import { debounceTime } from 'rxjs/operators';

@Component({
  selector: 'app-market-place-management',
  templateUrl: './market-place-management.component.html',
  styleUrls: ['./market-place-management.component.scss']
})
export class MarketPlaceManagement implements OnInit {
  sorts = [
    { key: 'NAME_ASC', value: 'Compensation A to Z'  },
    { key: 'NAME_DESC', value: 'Compensation Z to A' },
    { key: 'PRICE_ASC', value: 'Price A to Z' },
    { key: 'PRICE_DESC', value: 'Price Z to A' },
  ];

  public imageUrls: Array<any>;
  public checkParentStatus: boolean;

  isCategoryLoaded$: BehaviorSubject<boolean> = new BehaviorSubject<boolean>(false);
  isLoadingCategoryDetails$: BehaviorSubject<boolean> = new BehaviorSubject<boolean>(false);
  showLoadMore$: BehaviorSubject<boolean> = new BehaviorSubject<boolean>(false);
  loadedNumberOfCategories$: BehaviorSubject<number> = new BehaviorSubject<number>(0);
  totalNumberOfCategories$: BehaviorSubject<number> = new BehaviorSubject<number>(0);
  selectedCategoryId$: BehaviorSubject<string> = new BehaviorSubject<string>(null);
  Categories$: BehaviorSubject<ExperienceCompensationGridItemViewModel[]> = new BehaviorSubject<ExperienceCompensationGridItemViewModel[]>([]);
  
  
  areDetailsDisplayed$: BehaviorSubject<boolean> = new BehaviorSubject<boolean>(false);
  
  selectedCategoryDetails$: BehaviorSubject<ExperienceCompensationDetailsViewModel> = new BehaviorSubject<ExperienceCompensationDetailsViewModel>(new ExperienceCompensationDetailsViewModel({
    id: null,
    name: null,
    price: 0
  }));

  filterForm: FormGroup;
  
  constructor(
    public loading: LoadingService,
    private _formBuilder: FormBuilder,
    private _CategoryManagementClient: ExperienceCompensationManagementClient,
    private _route: ActivatedRoute,
    private _toastr: ToastrService) {
  }
  
  ngOnInit(): void {
    this.loading.start();
    this.imageUrls = [
      '../../../assets/images/alexa.png',
      '../../../assets/images/BACnet.png',
      '../../../assets/images/bowo.png',
      '../../../assets/images/Concierge.png',
      '../../../assets/images/Duve.png',
      '../../../assets/images/LOUNGE.png',
      '../../../assets/images/MQTT.png',
      '../../../assets/images/Niko.png',
      '../../../assets/images/nocore.png',
       '../../../assets/images/peekin.png',
       '../../../assets/images/QUICKtest.png',
    ]

    this.filterForm = this._formBuilder.group({
      sortKey: ['NAME_ASC'],
      keywords: [''],
    });

    this.filterForm.valueChanges.pipe(
      debounceTime(300)
    ).subscribe(
      (formValues: any) => { this._loadCategories(0); },
      (error: Error) => { },
      () => { }
    );

    this._loadCategories(0);
  }

  selectCategory(category: ExperienceCompensationGridItemViewModel) {
    this.isLoadingCategoryDetails$.next(true);
    this.selectedCategoryId$.next(category.id);
    this.loading.start();
    let request = new GetExperienceCompensationDetailsQuery({ id: category.id });

    this._CategoryManagementClient.getExperienceCompensationDetails(request).subscribe(
      (categoryDetails: ExperienceCompensationDetailsViewModel) => {
        this.selectedCategoryDetails$.next(categoryDetails);
        this.isCategoryLoaded$.next(true);
        this.areDetailsDisplayed$.next(true);
      },
      (error: Error) => {
        this._toastr.error(error.message);
      },
      () => {
        this.isLoadingCategoryDetails$.next(false);
        this.loading.stop();
      }
    );
  }

  loadMoreCategories() {
    this._loadCategories(this.loadedNumberOfCategories$.value);
  }

  newCategoryDetails() {
    this.selectedCategoryId$.next(null);
    this.selectedCategoryDetails$.next(this._createNewCategoryDetails());
    this.isCategoryLoaded$.next(true);

    this.areDetailsDisplayed$.next(true);
  }

  onCategoryInserted(category: ExperienceCompensationDetailsViewModel) {
    this.selectedCategoryDetails$.next(category);
    this.selectedCategoryId$.next(category.id);
    this.Categories$.next([...this.Categories$.value, new ExperienceCompensationGridItemViewModel(category)]);
    this.loadedNumberOfCategories$.next(this.loadedNumberOfCategories$.value + 1);
    this.totalNumberOfCategories$.next(this.totalNumberOfCategories$.value + 1);
  }

  onCategoryUpdated(category: ExperienceCompensationDetailsViewModel) {
    this.selectedCategoryDetails$.next(category);

    let Categories = [...this.Categories$.value];
    let categoryItem = Categories.find(c => c.id === category.id);
    if (categoryItem) {
      categoryItem.name = category.name;
      categoryItem.price = category.price;
      this.Categories$.next(Categories);
    }
  }

  onCategoryCancel() {
    this.areDetailsDisplayed$.next(false);
    this.selectedCategoryId$.next(null);
  }

  private _createNewCategoryDetails(): ExperienceCompensationDetailsViewModel {
    return new ExperienceCompensationDetailsViewModel({
      id: null,
      name: null,
      price: 0
    });
  }

  private _loadCategories(skip: number) {
    this.loading.start();

    let query: GetPageOfExperienceCompensationsQuery = new GetPageOfExperienceCompensationsQuery({
      skip: skip,
      take: 20,
      keywords: this.filterForm.controls.keywords.value,
      sortKey: this.filterForm.controls.sortKey.value
    });

    this._CategoryManagementClient.getPageOfExperienceCompensations(query).subscribe(
      (response: PageOfOfExperienceCompensationGridItemViewModel) => {
        if (skip === 0) {
          this.Categories$.next(response.items);
        } else {
          this.Categories$.next([...this.Categories$.value, ...response.items]);
        }
        this.totalNumberOfCategories$.next(response.totalNumberOfItems);
        this.loadedNumberOfCategories$.next(this.Categories$.value.length);
        this.showLoadMore$.next(this.loadedNumberOfCategories$.value < this.totalNumberOfCategories$.value);
      },
      (error: Error) => {
        this._toastr.error(error.message);
      },
      () => {
        this.loading.stop();
      },
    );
  }
}
