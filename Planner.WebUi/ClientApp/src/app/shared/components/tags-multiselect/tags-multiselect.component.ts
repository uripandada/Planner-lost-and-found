import { Component, OnInit, Input, EventEmitter, Output, ViewChild, ElementRef, Inject, Optional } from '@angular/core';
import { AuthorizeService, IUser } from '../../../../api-authorization/authorize.service';
import { Observable, BehaviorSubject } from 'rxjs';
import { HttpClient, HttpEvent, HttpEventType } from '@angular/common/http';
import { ToastrService } from 'ngx-toastr';
import { API_BASE_URL } from '../../../core/autogenerated-clients/api-client';
import { map, startWith } from 'rxjs/operators';
import { FormArray, FormBuilder, FormControl } from '@angular/forms';

export class TagItem {
  public key: string;
  public value: string;
}

@Component({
  selector: 'app-tags-multiselect',
  templateUrl: './tags-multiselect.component.html',
  styleUrls: ['./tags-multiselect.component.scss']
})
export class TagsMultiselectComponent implements OnInit {

  @Input() tags: Array<TagItem> = [];
  @Input() tagsFormArray: FormArray;
  @Output() tagAdded: EventEmitter<TagItem> = new EventEmitter<TagItem>();
  @Output() tagRemoved: EventEmitter<number> = new EventEmitter<number>();

  selectTagControl: FormControl;
  filteredTags$: Observable<Array<TagItem>>;

  constructor(private _formBuilder: FormBuilder) {
  }

  ngOnInit(): void {
    this.selectTagControl = new FormControl('');
    //this.filteredTags$.next(this.tags);

    this.filteredTags$ = this.selectTagControl.valueChanges
      .pipe(
        startWith(''),
        map(value => this._filter(value))
      );
  }

  private _filter(value) {
    if (typeof (value) === "string") {
      const filterValue = value.toLowerCase();
      return this.tags.filter(a => a.value.toLowerCase().indexOf(filterValue) >= 0);
    }
    else {
      if (value && typeof (value) === "object") {
        this.addTag();
      }

      return this.tags;
    }
  }

  displayTagName(tag) {
    if (tag && typeof (tag) === "object") {
      return tag.value;
    }
    return "";
  }

  removeTag(tagIndex: number) {
    this.tagsFormArray.removeAt(tagIndex);

    this.tagRemoved.next(tagIndex);
  }

  addTag() {
    let tagValue: any = this.selectTagControl.value;
    let tag = {
      key: null,
      value: null,
    }
    if (typeof (tagValue) === "object") {
      tag.key = tagValue.key;
      tag.value = tagValue.value;
    }
    else {
      tag.key = tagValue;
      tag.value = tagValue;
    }

    let existingTags = this.tagsFormArray.getRawValue();

    if (!existingTags.find(t => t.key === tag.key)) {
      this.tagsFormArray.push(this._formBuilder.group({
        key: [tag.key],
        value: [tag.value],
      }));
      this.tagAdded.next(tag);
    }

    this.selectTagControl.setValue('');
  }
}

