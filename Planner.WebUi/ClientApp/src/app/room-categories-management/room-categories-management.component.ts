import { Component, OnInit } from '@angular/core';
import { FormGroup, FormBuilder, FormArray, Validators } from '@angular/forms';
import { ActivatedRoute } from '@angular/router';
import { LoadingService } from '../core/services/loading.service';
import { ToastrService } from 'ngx-toastr';
import { HotelService } from '../core/services/hotel.service';
import { BehaviorSubject } from 'rxjs';
import { GetPageOfRoomCategoriesQuery, GetRoomCategoryDetailsQuery, InsertRoomCategoryCommand, PageOfOfRoomCategoryGridItemViewModel, ProcessResponse, ProcessResponseOfGuid, RoomCategoryDetailsViewModel, RoomCategoryGridItemViewModel, RoomCategoryManagementClient, UpdateRoomCategoryCommand } from '../core/autogenerated-clients/api-client';
import { debounceTime } from 'rxjs/operators';

@Component({
  selector: 'app-room-categories-management',
  templateUrl: './room-categories-management.component.html',
  styleUrls: ['./room-categories-management.component.scss']
})
export class RoomCategoriesManagementComponent implements OnInit {
  sorts = [
    { key: 'NAME_ASC', value: 'Name A to Z' },
    { key: 'NAME_DESC', value: 'Name Z to A' },
    { key: 'CREATED_AT_DESC', value: 'Newest first' },
    { key: 'CREATED_AT_ASC', value: 'Oldest first' },
  ];

  isRoomCategoryLoaded$: BehaviorSubject<boolean> = new BehaviorSubject<boolean>(false);
  isLoadingRoomCategoryDetails$: BehaviorSubject<boolean> = new BehaviorSubject<boolean>(false);
  showLoadMore$: BehaviorSubject<boolean> = new BehaviorSubject<boolean>(false);
  loadedNumberOfCategories$: BehaviorSubject<number> = new BehaviorSubject<number>(0);
  totalNumberOfCategories$: BehaviorSubject<number> = new BehaviorSubject<number>(0);
  selectedCategoryId$: BehaviorSubject<string> = new BehaviorSubject<string>(null);
  roomCategories$: BehaviorSubject<RoomCategoryGridItemViewModel[]> = new BehaviorSubject<RoomCategoryGridItemViewModel[]>([]);


  areDetailsDisplayed$: BehaviorSubject<boolean> = new BehaviorSubject<boolean>(false);

  selectedCategoryDetails$: BehaviorSubject<RoomCategoryDetailsViewModel> = new BehaviorSubject<RoomCategoryDetailsViewModel>(new RoomCategoryDetailsViewModel({
    id: null,
    isPrivate: false,
    name: null,
    isDefaultForReservationSync: false,
    isSystemDefaultForReservationSync: false,
  }));

  filterForm: FormGroup;

  constructor(
    public loading: LoadingService,
    private _formBuilder: FormBuilder,
    private _roomCategoryManagementClient: RoomCategoryManagementClient,
    private _route: ActivatedRoute,
    private _toastr: ToastrService) {
  }

  ngOnInit(): void {
    this.loading.start();

    this.filterForm = this._formBuilder.group({
      sortKey: ['NAME_ASC'],
      keywords: [''],
    });

    this.filterForm.valueChanges.pipe(
      debounceTime(300)
    ).subscribe(
      (formValues: any) => { this._loadRoomCategories(0); },
      (error: Error) => { },
      () => { }
    );

    this._loadRoomCategories(0);
  }

  selectCategory(category: RoomCategoryGridItemViewModel) {
    this.isLoadingRoomCategoryDetails$.next(true);
    this.selectedCategoryId$.next(category.id);
    this.loading.start();
    let request = new GetRoomCategoryDetailsQuery({ id: category.id });

    this._roomCategoryManagementClient.getRoomCategoryDetails(request).subscribe(
      (categoryDetails: RoomCategoryDetailsViewModel) => {
        this.selectedCategoryDetails$.next(categoryDetails);
        this.isRoomCategoryLoaded$.next(true);
        this.areDetailsDisplayed$.next(true);
      },
      (error: Error) => {
        this._toastr.error(error.message);
      },
      () => {
        this.isLoadingRoomCategoryDetails$.next(false);
        this.loading.stop();
      }
    );
  }

  loadMoreCategories() {
    this._loadRoomCategories(this.loadedNumberOfCategories$.value);
  }

  newCategoryDetails() {
    this.selectedCategoryId$.next(null);
    this.selectedCategoryDetails$.next(this._createNewCategoryDetails());
    this.isRoomCategoryLoaded$.next(true);

    this.areDetailsDisplayed$.next(true);
  }

  onRoomCategoryInserted(category: RoomCategoryDetailsViewModel) {
    this.selectedCategoryDetails$.next(category);
    this.selectedCategoryId$.next(category.id);
    this.roomCategories$.next([...this.roomCategories$.value, new RoomCategoryGridItemViewModel(category)]);
    this.loadedNumberOfCategories$.next(this.loadedNumberOfCategories$.value + 1);
    this.totalNumberOfCategories$.next(this.totalNumberOfCategories$.value + 1);
  }

  onRoomCategoryUpdated(category: RoomCategoryDetailsViewModel) {
    this.selectedCategoryDetails$.next(category);

    let roomCategories = [...this.roomCategories$.value];
    let categoryItem = roomCategories.find(c => c.id === category.id);
    if (categoryItem) {
      categoryItem.name = category.name;
      categoryItem.isPrivate = category.isPrivate;

      this.roomCategories$.next(roomCategories);
    }
  }

  onRoomCategoryCancel() {
    this.areDetailsDisplayed$.next(false);
    this.selectedCategoryId$.next(null);
  }

  private _createNewCategoryDetails(): RoomCategoryDetailsViewModel {
    return new RoomCategoryDetailsViewModel({
      id: null,
      isPrivate: false,
      name: null,
      isDefaultForReservationSync: false,
      isSystemDefaultForReservationSync: false,
    });
  }

  private _loadRoomCategories(skip: number) {
    this.loading.start();

    let query: GetPageOfRoomCategoriesQuery = new GetPageOfRoomCategoriesQuery({
      skip: skip,
      take: 20,
      keywords: this.filterForm.controls.keywords.value,
      sortKey: this.filterForm.controls.sortKey.value
    });

    this._roomCategoryManagementClient.getPageOfRoomCategories(query).subscribe(
      (response: PageOfOfRoomCategoryGridItemViewModel) => {
        if (skip === 0) {
          this.roomCategories$.next(response.items);
        } else {
          this.roomCategories$.next([...this.roomCategories$.value, ...response.items]);
        }
        this.totalNumberOfCategories$.next(response.totalNumberOfItems);
        this.loadedNumberOfCategories$.next(this.roomCategories$.value.length);
        this.showLoadMore$.next(this.loadedNumberOfCategories$.value < this.totalNumberOfCategories$.value);
      },
      (error: Error) => {
        this._toastr.error(error.message);
      },
      () => {
        this.loading.stop();
      },
    );
  }
}
